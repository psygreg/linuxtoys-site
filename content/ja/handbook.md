# 開発者ハンドブック

## I. 貢献ガイドライン

LinuxToysへの貢献にご興味をお持ちいただき、ありがとうございます！このプロジェクトは、ユーザーフレンドリーな方法でLinux用ツールのコレクションを提供し、強力な機能をすべてのユーザーがアクセスできるようにすることを目的としています。

### ドキュメント

開始する前に、LinuxToysのライブラリと開発プラクティスに関する完全なドキュメントについて、[開発者ハンドブック](https://github.com/psygreg/linuxtoys/wiki/Developer-Handbook)をご確認ください。

#### 開発優先順位

LinuxToysに貢献する際は、重要度順に列挙されたこれらの中核優先順位を念頭に置いてください：

#### 1. 安全性とプライバシーを第一に
- **ユーザーの安全性とプライバシーは常に最優先でなければならない**
- すべてのスクリプトとツールは徹底的にテストし、レビューする必要があります
- ユーザーデータやシステムセキュリティを危険にさらす可能性のある機能は決して実装しないでください
- 潜在的なリスクやシステム変更を明確に文書化してください
- 安全なコーディング慣行に従い、すべてのユーザー入力を検証してください

#### 2. ユーザーフレンドリーさとアクセシビリティ
- 平均的なコンピューターユーザーを念頭に置いて設計してください
- 明確で直感的なインターフェースを提供してください
- すべての機能について役立つ説明とガイダンスを含め、要点を簡潔に保ってください
- 異なる技術スキルレベルのユーザーのアクセシビリティを確保してください
- ユーザー向けテキストとエラーメッセージでは平易な言語を使用してください

#### 3. 信頼性と自己完結性
- **すべての機能は、ユーザーから追加の回避策を必要とせずに意図されたとおりに動作する必要があります**
- ツールはエッジケースを優雅に処理する必要があります
- 何かがうまくいかない場合は明確なエラーメッセージを提供してください
- サポートされているディストリビューションとバージョン全体でテストしてください
- 依存関係が適切に管理され、文書化されていることを確認してください

#### 4. CLIツールの制限
- **コマンドラインインターフェースは開発者とシステム管理者の使用例に制限されるべきです**
- 平均的なコンピューターユーザーは端末エミュレーターを知らないか、扱いたくありません
- CLI専用機能は開発者とシステム管理メニューに制限されるべきです

### 最後に...

- すべてのプルリクエストは承認前に手動でレビューされます
- あなたの貢献が上記の開発優先順位と一致していることを確認してください
- 可能であれば、異なるLinuxディストリビューション全体で変更をテストしてください
- 既存のコードスタイルと構造に従ってください
- 新機能や重要な変更を文書化してください

### はじめに

1. [開発者ハンドブック](https://github.com/psygreg/linuxtoys/wiki/Developer-Handbook)をレビューしてください
2. リポジトリをフォークし、機能ブランチを作成してください
3. 開発優先順位に従って変更を行ってください
4. サポートされているシステム全体で徹底的にテストしてください
5. 変更の明確な説明を含むプルリクエストを送信してください

Linuxをすべてのユーザーにとってよりアクセシブルでユーザーフレンドリーにするためのあなたの貢献に感謝します！

## II. LinuxToysの機能と使用法

### スクリプト構造とメタデータ

#### 基本スクリプトテンプレート

すべてのLinuxToysスクリプトは、メタデータヘッダーを持つ標準化された構造に従います：

```bash
#!/bin/bash
# name: Human Readable Name (または翻訳用プレースホルダー)
# version: 1.0
# description: description_key_or_text
# icon: icon-name
# compat: ubuntu, debian, fedora, arch, cachy, suse, ostree, ublue
# reboot: no|yes|ostree
# noconfirm: yes
# localize: en, pt...
# nocontainer

# --- スクリプトコードの開始 ---
. /etc/os-release
SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
source "$SCRIPT_DIR/../../libs/linuxtoys.lib"
_lang_
source "$SCRIPT_DIR/../../libs/lang/${langfile}.lib"
source "$SCRIPT_DIR/../../libs/helpers.lib"

# ここにスクリプトロジック
```

#### メタデータヘッダー

**必須ヘッダー**

- **`# name:`** - UIに表示される表示名
- **`# version:`** - スクリプトバージョン（通常「1.0」）
- **`# description:`** - 翻訳用説明キーまたは直接テキスト
- **`# icon:`** - UI用アイコン識別子 - *チェックリストメニューでは不要*

**オプションヘッダー**

- **`# compat:`** - 互換性のあるディストリビューションのカンマ区切りリスト
- **`# reboot:`** - 再起動要件：`no`（デフォルト）、`yes`、または`ostree`
- **`# noconfirm:`** - `yes`に設定されている場合、確認ダイアログをスキップ
- **`# localize:`** - サポートされているロケールのカンマ区切りリスト
- **`# nocontainer:`** - コンテナ化環境でスクリプトを非表示

#### 互換性システム

LinuxToysは互換性キーシステムを通じて複数のLinuxディストリビューションをサポートします：

**サポートされているディストリビューション**

- **`ubuntu`** - Ubuntuと派生版
- **`debian`** - Debianと派生版
- **`fedora`** - FedoraとRHELベースシステム
- **`arch`** - Arch Linux（CachyOSを除く）
- **`cachy`** - CachyOS専用
- **`suse`** - openSUSEとSUSEシステム
- **`ostree`** - rpm-ostreeベースシステム
- **`ublue`** - Universal Blueイメージ（Bazzite、Bluefin、Aurora）

#### 再起動要件
- **`no`** - 再起動不要（デフォルト）
- **`yes`** - 常に再起動が必要
- **`ostree`** - ostree/ublueシステムでのみ再起動が必要

#### コンテナ検出

アプリケーションはコンテナ内から実行されているかどうかを検出し、対応するヘッダーに応じて特定のオプションを非表示または表示することができます。これは`compat`キーとも互換性があります。

**例**

- **`# nocontainer`** - コンテナ化環境でスクリプトを非表示
- **`# nocontainer: ubuntu, debian`** - UbuntuとDebianコンテナでのみスクリプトを非表示
- **`# nocontainer: invert`** - コンテナ化環境で**のみ**スクリプトを表示
- **`# nocontainer: invert, debian`** - Debianコンテナでのみスクリプトを表示

### コアライブラリ

#### linuxtoys.lib

メインライブラリはスクリプト操作に必要な基本機能を提供します：

**パッケージ管理**

```bash
# インストールするパッケージを宣言
_packages=(package1 package2 package3)
_install_
```

`_install_`関数は自動的に：
- パッケージマネージャーを検出（apt、pacman、dnf、zypper、rpm-ostree）
- パッケージが既にインストールされているかをチェック
- 適切な方法を使用して不足パッケージをインストール
- レイヤードパッケージでrpm-ostreeシステムを処理
- 完了時に`_packages`変数をアンセット、必要に応じて同じスクリプトで複数回使用可能

**Flatpak管理**

```bash
# インストールするパッケージを宣言
_flatpaks=(package1 package2 package3)
_flatpak_
```

`_flatpak_`関数は標準パラメータ（ユーザーレベル、Flathubリポジトリ）で配列内の各flatpakを自動的にインストールします。完了時に`_flatpaks`もアンセットし、必要に応じて同じスクリプトで複数回使用できます。

**ユーザーインターフェース機能**

```bash
# GUIでsudoパスワードを要求
sudo_rq

# 情報ダイアログを表示
zeninf "情報メッセージ"

# 警告ダイアログを表示
zenwrn "警告メッセージ"

# エラーを表示して終了
fatal "致命的エラーメッセージ"

# エラーを表示するが続行
nonfatal "非致命的エラーメッセージ"
```

**言語検出**

```bash
# システム言語を検出し翻訳ファイルを設定
_lang_
# これは$langfile変数を設定します（例：「en」、「pt」）
```

### 言語とローカライゼーション

#### 翻訳システム

LinuxToysはJSON翻訳ファイルを通じて複数言語をサポートします：

**言語ファイル構造**

```
p3/libs/lang/
├── en.json    # 英語（フォールバック）
├── pt.json    # ポルトガル語
└── ...
```

#### 翻訳の使用
```bash
# 言語検出をロード
_lang_
source "$SCRIPT_DIR/../../libs/lang/${langfile}.lib"

# zenityダイアログで翻訳を使用
zenity --question --text "$translation_key" --width 360 --height 300
```

`_flatpak_`関数は標準パラメータ（ユーザーレベル、Flathubリポジトリ）で配列内の各flatpakを自動的にインストールします。完了時に`_flatpaks`もアンセットし、必要に応じて同じスクリプトで複数回使用できます。

**ユーザーインターフェース機能**

```bash
# GUIでsudoパスワードを要求
sudo_rq

# 情報ダイアログを表示
zeninf "情報メッセージ"

# 警告ダイアログを表示
zenwrn "警告メッセージ"

# エラーを表示して終了
fatal "致命的エラーメッセージ"

# エラーを表示するが続行
nonfatal "非致命的エラーメッセージ"
```

**言語検出**

```bash
# システム言語を検出し翻訳ファイルを設定
_lang_
# これは$langfile変数を設定します（例：「en」、「pt」）
```

#### helpers.lib

一般的なタスク用の専門的なヘルパー関数を提供：

**Flatpak管理**

```bash
# FlatpakとFlathubリポジトリを設定
flatpak_in_lib
# その後Flatpakアプリケーションをインストール：
flatpak install --or-update --user --noninteractive app.id
```

`flatpak_in_lib`関数：
- 存在しない場合Flatpakをインストール
- ユーザーとシステム用にFlathubリモートを追加
- 異なるパッケージマネージャーを自動的に処理
- エラーハンドリングと検証を提供

**リポジトリ管理**

```bash
# Archシステムでmultilibリポジトリを有効化
multilib_chk

# ArchシステムでChaotic-AURリポジトリを追加
chaotic_aur_lib

# FedoraシステムでRPMFusionリポジトリをインストール
rpmfusion_chk
```

### 言語とローカライゼーション

#### 翻訳システム

LinuxToysはJSON翻訳ファイルを通じて複数言語をサポートします：

**言語ファイル構造**

```
p3/libs/lang/
├── en.json    # 英語（フォールバック）
├── pt.json    # ポルトガル語
└── ...
```

#### 翻訳の使用
```bash
# 言語検出をロード
_lang_
source "$SCRIPT_DIR/../../libs/lang/${langfile}.lib"

# zenityダイアログで翻訳を使用
zenity --question --text "$translation_key" --width 360 --height 300
```

シンプルなダイアログに使用できる標準メッセージキーがあります。
- `$finishmsg`：「_操作が完了しました。_」
- `$rebootmsg`：「_インストール完了。変更を有効にするには再起動してください。_」
- `$cancelmsg`：「_キャンセル_」
- `$incompatmsg`：「_お使いのオペレーティングシステムは互換性がありません。_」
- `$abortmsg`：「_ユーザーによって操作がキャンセルされました。_」
- `$notdomsg`：「_何もすることがありません。_」

**標準削除ダイアログ**
- `$rmmsg`：「_`$LT_PROGRAM`が既にインストールされています。削除しますか？_」

事前に`LT_PROGRAM`変数を設定する必要があります。

**翻訳の追加**

1. すべての言語JSONファイルに翻訳キーを追加
2. スクリプト説明で翻訳キーを使用：`# description: app_desc`
3. ダイアログとメッセージでキーを参照

#### ローカライゼーション制御
```bash
# 特定のロケールにスクリプトを制限
# localize: pt
# このスクリプトはポルトガル語話者のユーザーのみに表示
```

### コンテナ互換性

#### コンテナ検出

LinuxToysはコンテナ化環境を自動的に検出し、それに応じてスクリプトをフィルタリングできます。

#### コンテナ制限
```bash
# すべてのコンテナでスクリプトを非表示
# nocontainer

# 特定のディストリビューションコンテナでのみスクリプトを非表示
# nocontainer: debian, ubuntu
```

**自動フィルタリング**

`flatpak_in_lib`を使用するスクリプトは、互換性のあるシステムを指定する`nocontainer`ヘッダーで明示的に許可されない限り、コンテナで自動的に非表示になります。

### 高度な機能

#### 開発モード

LinuxToysにはテストとデバッグ用の開発モードが含まれています：

#### 環境変数
- **`DEV_MODE=1`** - 開発者モードを有効化
- **`COMPAT=distro`** - 互換性検出を上書き
- **`CONTAINER=1`** - コンテナ環境をシミュレート
- **`OPTIMIZER=1/0`** - 最適化状態をシミュレート

#### 開発者オーバーライド
```bash
# 互換性に関係なくすべてのスクリプトを表示
DEV_MODE=1 ./run.py

# 特定のディストリビューションでスクリプトをテスト
DEV_MODE=1 COMPAT=arch ./run.py

# コンテナ動作をテスト
DEV_MODE=1 CONTAINER=1 ./run.py

# デフォルト最適化切り替えをテスト
DEV_MODE=1 OPTIMIZER=1 ./run.py
```

#### 実行される検査
- 基本的なbash構文
- `sudo_rq`による適切な`sudo`昇格方法
- 適切なライブラリソーシング
- ヘッダー要素チェック（いくつかは必須ではないため警告のみ）

### 再起動管理

LinuxToysは包括的な再起動処理を提供します：

#### 再起動検出
```bash
# スクリプトが再起動を必要とするかチェック
script_requires_reboot(script_path, system_compat_keys)

# 保留中のostreeデプロイメントをチェック
check_ostree_pending_deployments()
```

**再起動ダイアログ**

- 自動再起動警告ダイアログ
- 「今すぐ再起動」と「後で再起動」の間のユーザー選択
- 再起動要件時の優雅なアプリケーション終了
- ostree保留デプロイメントの特別処理

### エラー処理

#### ベストプラクティス
```bash
# コマンドの成功をチェック
if ! command_that_might_fail; then
    nonfatal "コマンドが失敗しました、続行します..."
    return 1
fi

# 重要な失敗
if ! critical_command; then
    fatal "重要な操作が失敗しました"
fi

# サイレントエラー処理
command_with_output 2>/dev/null || true
```

### スクリプトカテゴリ

#### 組織構造
```
p3/scripts/
├── office/          # オフィス＆ワークアプリケーション
├── game/           # ゲームツールとランチャー
├── devs/           # 開発者ツール
├── utils/          # システムユーティリティ
├── drivers/        # ハードウェアドライバー
├── repos/          # リポジトリ管理
├── extra/          # 実験的/追加ツール
├── pdefaults.sh    # システム最適化
└── psypicks.sh     # 厳選されたソフトウェア選択
```

#### カテゴリ情報

各カテゴリは`category-info.txt`ファイルを持つことができます：
```
name: カテゴリ表示名
description: カテゴリ説明キー
icon: folder-icon-name
mode: menu
```

### ベストプラクティス

#### スクリプト開発
1. **適切な分類とフィルタリングのためにメタデータヘッダーを常に使用**
2. **可能であれば異なるディストリビューション全体で互換性をテスト**
3. **適切なユーザーフィードバックでエラーを優雅に処理**
4. **共通機能を再実装する代わりに既存のライブラリを使用**
5. **一貫性のために標準スクリプト構造に従う**

#### パッケージ管理
1. **`_install_`を呼び出す前に配列でパッケージを宣言**
2. **異なるディストリビューションのパッケージ可用性をチェック**
3. **rpm-ostreeシステムを適切に処理**（非必要パッケージを避ける）
4. **可能であればGUIアプリケーションにFlatpakを使用**

#### ユーザーエクスペリエンス
1. **提供された言語で明確な説明を提供**
2. **視覚的識別のために適切なアイコンを使用**
3. **再起動要件を適切に処理**
4. **長時間の操作中に進行状況とフィードバックを表示**
5. **確認ダイアログでユーザーの選択を尊重**

#### ローカライゼーション
1. **ハードコードされたテキストの代わりに翻訳キーを使用**
2. **サポートされているすべての言語の翻訳を提供**
3. **適切な機能を確保するために異なるロケールでテスト**
4. **スクリプトが地域固有の場合はロケール制限を使用**

このガイドは、LinuxToysエコシステム内で堅牢で互換性があり、ユーザーフレンドリーなスクリプトを作成するための基盤を提供します。提供されたライブラリを活用し、これらの規約に従うことで、開発者は複数のLinuxディストリビューション全体でシームレスに動作し、一貫したユーザーエクスペリエンスを提供するスクリプトを作成できます。

## III. AIコーディングエージェント

AIツールの使用が日々より一般的になっている中、LinuxToysの開発におけるその使用に関するガイドラインを確立することが重要です。これらのツールは非常に役立つツールとなり、適度で責任ある方法で使用されれば、開発者がより効率的になるのを助けることができると我々は信じています。

### 許可されたモデル

テストに基づいて、コード支援には*以下のモデルのみ*を許可します：
- **Grok Code Fast** - 高速で費用対効果の高いモデル、「ステロイド版オートコンプリート」としての使用に理想的
- **Claude Sonnet 4** - 高度なモデル、複雑なコード分析と作業に適していますが、より高価でもあります
- **Qwen Coder 3** - バランスの取れたモデル、様々なコーディングタスクに良いパフォーマンスを提供しながら、良い精度と費用効率を維持

テストしたその他のモデルはすべて、長期的に満足のいく結果を提供することに失敗し、制御不能な幻覚で不正確または危険なコードを生成することが多くありました。

### 使用ガイドライン

1. **補完、置換しない**：AIツールは人間のコーディング努力を支援し強化するために使用されるべきで、完全に置き換えるためではありません。
2. **コードレビュー**：いかなる能力においてもAIによって生成されたすべてのコードは、どのようなコードでもそうであるように、私たちの高い品質、セキュリティ、機能基準を満たすことを確実にするために徹底的にレビューし、テストする必要があります。
3. **セキュリティ意識**：AI生成コードの潜在的なセキュリティ脆弱性について警戒してください。AIは常に最良のセキュリティプラクティスに従うとは限りません。

### 翻訳におけるAI使用

LinuxToysを人々の母国語で利用できるようにすることは、ソフトウェアをよりアクセシブルにするため非常に重要であり、これは私たちの成功の重要な要因であることを理解しています。しかし、これは非常に時間のかかるタスクでもあり、私たちよりもはるかに大きなプロジェクトでさえ、これを手伝ってくれるボランティアを見つけるのに苦労しているため、翻訳の生成にAIツールを使用しています。翻訳の不正確さや間違いは、私たちの[GitHub issuesページ](https://github.com/psygreg/linuxtoys/issues)で報告してください。

現在私たちの翻訳に使用されているモデルは**Claude Sonnet 4**です。これは私たちのテストで最良の結果を示し、元の意味からの逸脱がなかったためです。

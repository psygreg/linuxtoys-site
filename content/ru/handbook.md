# Руководство разработчика

## I. Руководство по внесению вклада

Спасибо за интерес к участию в разработке LinuxToys! Этот проект направлен на предоставление коллекции инструментов для Linux удобным для пользователя способом, делая мощную функциональность доступной для всех пользователей.

### Документация

Прежде чем начать, пожалуйста, ознакомьтесь с [Руководством разработчика](https://github.com/psygreg/linuxtoys/wiki/Developer-Handbook) для полной документации по библиотекам LinuxToys и практикам разработки.

#### Приоритеты разработки

При внесении вклада в LinuxToys, пожалуйста, помните об этих основных приоритетах, перечисленных в порядке важности:

#### 1. Безопасность и конфиденциальность прежде всего
- **Безопасность и конфиденциальность пользователя всегда должны быть высшим приоритетом**
- Все скрипты и инструменты должны быть тщательно протестированы и проверены
- Никогда не реализуйте функции, которые могут скомпрометировать данные пользователя или безопасность системы
- Четко документируйте любые потенциальные риски или изменения системы
- Следуйте практикам безопасного кодирования и проверяйте все пользовательские входы

#### 2. Удобство использования и доступность
- Проектируйте с учетом среднего пользователя компьютера
- Предоставляйте четкие, интуитивные интерфейсы
- Включайте полезные описания и руководство для всех функций, сохраняя лаконичность
- Обеспечивайте доступность для пользователей с разными уровнями технических навыков
- Используйте простой язык в пользовательском тексте и сообщениях об ошибках

#### 3. Надежность и самодостаточность
- **Все функции должны работать как задумано, не требуя дополнительных обходных путей от пользователя**
- Инструменты должны грациозно обрабатывать крайние случаи
- Предоставляйте четкие сообщения об ошибках, когда что-то идет не так
- Тестируйте на поддерживаемых дистрибутивах и версиях
- Убедитесь, что зависимости правильно управляются и документированы

#### 4. Ограничения инструментов CLI
- **Интерфейсы командной строки должны быть ограничены случаями использования разработчиками и системными администраторами**
- Средний пользователь компьютера не знает или не хочет иметь дело с эмуляторами терминала
- Функции только CLI должны быть ограничены меню разработчика и системного администрирования

### Наконец...

- Все Pull Request будут вручную проверены перед одобрением
- Убедитесь, что ваши вклады соответствуют приоритетам разработки, перечисленным выше
- Тестируйте свои изменения на разных дистрибутивах Linux, когда это возможно
- Следуйте существующему стилю кода и структуре
- Документируйте любые новые функции или значительные изменения

### Начало работы

1. Ознакомьтесь с [Руководством разработчика](https://github.com/psygreg/linuxtoys/wiki/Developer-Handbook)
2. Сделайте форк репозитория и создайте ветку функции
3. Внесите изменения, следуя приоритетам разработки
4. Тщательно тестируйте на поддерживаемых системах
5. Отправьте Pull Request с четким описанием ваших изменений

Мы ценим ваш вклад в то, чтобы сделать Linux более доступным и удобным для всех!

## II. Функции и использование LinuxToys

### Структура скрипта и метаданные

#### Базовый шаблон скрипта

Все скрипты LinuxToys следуют стандартизированной структуре с заголовками метаданных:

```bash
#!/bin/bash
# name: Human Readable Name (или заполнитель для перевода)
# version: 1.0
# description: description_key_or_text
# icon: icon-name
# compat: ubuntu, debian, fedora, arch, cachy, suse, ostree, ublue
# reboot: no|yes|ostree
# noconfirm: yes
# localize: en, pt...
# nocontainer
# repo: https://repo.url

# --- Начало кода скрипта ---
source "$SCRIPT_DIR/libs/linuxtoys.lib"
_lang_
source "$SCRIPT_DIR/libs/lang/${langfile}.lib"
source "$SCRIPT_DIR/libs/helpers.lib"

# Ваша логика скрипта здесь
```

#### Заголовки метаданных

**Обязательные заголовки**

- **`# name:`** - Отображаемое имя, показываемое в UI
- **`# version:`** - Версия скрипта (обычно "1.0")
- **`# description:`** - Ключ описания для переводов или прямой текст
- **`# icon:`** - Идентификатор иконки для UI - *не требуется в меню контрольных списков*

**Опциональные заголовки**

- **`# compat:`** - Список совместимых дистрибутивов через запятую
- **`# reboot:`** - Требование перезагрузки: `no` (по умолчанию), `yes` или `ostree`
- **`# noconfirm:`** - Пропустить диалог подтверждения, если установлено в `yes`
- **`# localize:`** - Список поддерживаемых локалей через запятую
- **`# nocontainer:`** - Скрыть скрипт в контейнерных средах
- **`# gpu:`** - Отображать скрипт только для выбранных производителей GPU, допустимые значения `Amd`, `Intel`, `Nvidia`. Может иметь более одного производителя.
- **`# desktop:`** - Отображать скрипт только для выбранных сред рабочего стола, допустимые значения `gnome`, `plasma` и `other`.
- **`#repo:`** - Делает имя скрипта кликабельным в диалогах подтверждения. Должен позволять пользователю быстро перейти к оригинальному репозиторию соответствующей функции.

#### Система совместимости

LinuxToys поддерживает множественные дистрибутивы Linux через систему ключей совместимости:

**Поддерживаемые дистрибутивы**

- **`ubuntu`** - Ubuntu и производные
- **`debian`** - Debian и производные
- **`fedora`** - Fedora и системы на базе RHEL
- **`arch`** - Arch Linux (исключая CachyOS)
- **`cachy`** - CachyOS специально
- **`suse`** - openSUSE и системы SUSE
- **`ostree`** - системы на базе rpm-ostree
- **`ublue`** - образы Universal Blue (Bazzite, Bluefin, Aurora)

#### Требования перезагрузки
- **`no`** - Перезагрузка не требуется (по умолчанию)
- **`yes`** - Всегда требует перезагрузку
- **`ostree`** - Требует перезагрузку только на системах ostree/ublue

### Основные библиотеки

#### linuxtoys.lib

Главная библиотека предоставляет основные функции для операций скриптов:

**Управление пакетами**

```bash
# Объявить пакеты для установки
_packages=(package1 package2 package3)
_install_
```

Функция `_install_` автоматически:
- Определяет менеджер пакетов (apt, pacman, dnf, zypper, rpm-ostree)
- Проверяет, установлены ли пакеты уже
- Устанавливает недостающие пакеты, используя подходящий метод
- Обрабатывает системы rpm-ostree со слоистыми пакетами
- Сбрасывает переменную `_packages` при завершении, позволяя использовать её несколько раз в том же скрипте при необходимости

**Управление Flatpak**

```bash
# Объявить пакеты для установки
_flatpaks=(package1 package2 package3)
_flatpak_
```

Функция `_flatpak_` автоматически устанавливает каждый flatpak в массиве со стандартными параметрами (пользовательский уровень, репозиторий Flathub). Она также сбросит `_flatpaks` при завершении, позволяя использовать её несколько раз в том же скрипте при необходимости.

**Функции пользовательского интерфейса**

```bash
# Запросить пароль sudo с GUI
sudo_rq

# Показать информационный диалог
zeninf "Информационное сообщение"

# Показать предупреждающий диалог
zenwrn "Предупреждающее сообщение"

# Показать ошибку и выйти
fatal "Сообщение о фатальной ошибке"

# Показать ошибку, но продолжить
nonfatal "Сообщение о нефатальной ошибке"
```

**Определение языка**

```bash
# Определить язык системы и установить файл перевода
_lang_
# Это устанавливает переменную $langfile (например, "en", "pt")
```

#### helpers.lib

Предоставляет специализированные вспомогательные функции для общих задач:

**Управление Flatpak**

```bash
# Настроить Flatpak и репозиторий Flathub
flatpak_in_lib
# Затем установить приложения Flatpak:
flatpak install --or-update --user --noninteractive app.id
```

Функция `flatpak_in_lib`:
- Устанавливает Flatpak, если отсутствует
- Добавляет удаленный Flathub для пользователя и системы
- Автоматически обрабатывает разные менеджеры пакетов
- Предоставляет обработку ошибок и проверку

**Управление репозиториями**

```bash
# Включить репозиторий multilib в системах Arch
multilib_chk

# Добавить репозиторий Chaotic-AUR в системах Arch
chaotic_aur_lib

# Установить репозитории RPMFusion в системах Fedora
rpmfusion_chk
```

### Язык и локализация

#### Система переводов

LinuxToys поддерживает множественные языки через файлы переводов JSON:

**Структура языковых файлов**

```
p3/libs/lang/
├── en.json    # Английский (запасной)
├── pt.json    # Португальский
└── ...
```

#### Использование переводов
```bash
# Загрузить определение языка
_lang_
source "$SCRIPT_DIR/../../libs/lang/${langfile}.lib"

# Использовать переводы в диалогах zenity
zenity --question --text "$translation_key" --width 360 --height 300
```

Есть некоторые стандартные ключи сообщений, которые вы можете использовать для простых диалогов.
- `$finishmsg`: "_Операции завершены._"
- `$rebootmsg`: "_Установка завершена. Перезагрузитесь для применения изменений._"
- `$cancelmsg`: "_Отмена_"
- `$incompatmsg`: "_Ваша операционная система несовместима._"
- `$abortmsg`: "_Операция отменена пользователем._"
- `$notdomsg`: "_Нечего делать._"

**Стандартный диалог удаления**
- `$rmmsg`: "_У вас уже установлен `$LT_PROGRAM`. Хотите удалить его?_"

Требует предварительной установки переменной `LT_PROGRAM`.

**Добавление переводов**

1. Добавить ключи перевода во все языковые JSON файлы
2. Использовать ключи перевода в описаниях скриптов: `# description: app_desc`
3. Ссылаться на ключи в диалогах и сообщениях

#### Контроль локализации
```bash
# Ограничить скрипт определенными локалями
# localize: pt
# Этот скрипт будет показан только португалоговорящим пользователям
```

### Совместимость с контейнерами

#### Обнаружение контейнеров

LinuxToys автоматически обнаруживает контейнерные среды и может фильтровать скрипты соответственно.

#### Ограничения контейнеров
```bash
# Скрыть скрипт во всех контейнерах
# nocontainer

# Скрыть скрипт только в контейнерах конкретных дистрибутивов
# nocontainer: debian, ubuntu
```

**Автоматическая фильтрация**

Скрипты, использующие `flatpak_in_lib`, автоматически скрываются в контейнерах, если явно не разрешены заголовками `nocontainer`, указывающими совместимые системы.

### Расширенные функции

#### Режим разработки

LinuxToys включает режим разработки для тестирования и отладки:

#### Переменные окружения
- **`DEV_MODE=1`** - Включить режим разработки
- **`COMPAT=distro`** - Переопределить обнаружение совместимости
- **`CONTAINER=1`** - Имитировать контейнерную среду
- **`OPTIMIZER=1/0`** - Имитировать состояние оптимизации

#### Переопределения разработчика
```bash
# Показать все скрипты независимо от совместимости
DEV_MODE=1 ./run.py

# Тестировать скрипт на конкретном дистрибутиве
DEV_MODE=1 COMPAT=arch ./run.py

# Тестировать поведение контейнера
DEV_MODE=1 CONTAINER=1 ./run.py

# Тестировать переключение оптимизации по умолчанию
DEV_MODE=1 OPTIMIZER=1 ./run.py
```

#### Выполняемые проверки
- Базовый синтаксис bash
- Правильный метод повышения `sudo` через `sudo_rq`
- Правильное подключение библиотек
- Проверки элементов заголовка (только предупреждения, поскольку некоторые не обязательны)

### Управление перезагрузкой

LinuxToys обеспечивает комплексную обработку перезагрузки:

#### Обнаружение перезагрузки
```bash
# Проверить, требует ли скрипт перезагрузки
script_requires_reboot(script_path, system_compat_keys)

# Проверить ожидающие развертывания ostree
check_ostree_pending_deployments()
```

**Диалоги перезагрузки**

- Автоматические диалоги предупреждения о перезагрузке
- Выбор пользователя между "Перезагрузить сейчас" и "Перезагрузить позже"
- Грациозное закрытие приложения при требовании перезагрузки
- Специальная обработка ожидающих развертываний ostree

### Обработка ошибок

#### Лучшие практики
```bash
# Проверить успех команды
if ! command_that_might_fail; then
    nonfatal "Команда не удалась, продолжаем..."
    return 1
fi

# Критический сбой
if ! critical_command; then
    fatal "Критическая операция не удалась"
fi

# Молчаливая обработка ошибок
command_with_output 2>/dev/null || true
```

### Категории скриптов

#### Структура организации
```
p3/scripts/
├── office/          # Офисные и рабочие приложения
├── game/           # Игровые инструменты и лаунчеры
├── devs/           # Инструменты разработчика
├── utils/          # Системные утилиты
├── drivers/        # Драйверы оборудования
├── repos/          # Управление репозиториями
├── extra/          # Экспериментальные/дополнительные инструменты
├── pdefaults.sh    # Системные оптимизации
└── psypicks.sh     # Курированный выбор программного обеспечения
```

#### Информация о категории

Каждая категория может иметь файл `category-info.txt`:
```
name: Отображаемое имя категории
description: Ключ описания категории
icon: folder-icon-name
mode: menu
```

### Лучшие практики

#### Разработка скриптов
1. **Всегда используйте заголовки метаданных** для правильной категоризации и фильтрации
2. **Тестируйте совместимость** на разных дистрибутивах, когда возможно
3. **Обрабатывайте ошибки грациозно** с подходящей обратной связью пользователю
4. **Используйте существующие библиотеки** вместо переимплементации общей функциональности
5. **Следуйте стандартной структуре скрипта** для согласованности

#### Управление пакетами
1. **Объявляйте пакеты в массивах** перед вызовом `_install_`
2. **Проверяйте доступность пакетов** для разных дистрибутивов
3. **Обрабатывайте системы rpm-ostree** соответственно (избегайте несущественных пакетов)
4. **Используйте Flatpak для GUI приложений** когда возможно

#### Пользовательский опыт
1. **Предоставляйте четкие описания** на предоставленных языках
2. **Используйте соответствующие иконки** для визуальной идентификации
3. **Обрабатывайте требования перезагрузки** правильно
4. **Показывайте прогресс и обратную связь** во время длительных операций
5. **Уважайте выбор пользователей** в диалогах подтверждения

#### Локализация
1. **Используйте ключи перевода** вместо жестко закодированного текста
2. **Предоставляйте переводы** для всех поддерживаемых языков
3. **Тестируйте с разными локалями** для обеспечения правильной функциональности
4. **Используйте ограничения локали** когда скрипты специфичны для региона

Это руководство обеспечивает основу для создания надежных, совместимых и удобных для пользователя скриптов в экосистеме LinuxToys. Используя предоставленные библиотеки и следуя этим соглашениям, разработчики могут создавать скрипты, которые работают беспрепятственно на множественных дистрибутивах Linux, обеспечивая согласованный пользовательский опыт.

## III. ИИ-агенты кодирования

Поскольку использование ИИ-инструментов становится все более распространенным с каждым днем, важно установить некоторые руководящие принципы для их использования в разработке LinuxToys. Мы считаем, что они могут быть очень полезными инструментами и помочь разработчикам быть более эффективными, если используются умеренно и ответственно.

### Разрешенные модели

Основываясь на тестировании, мы разрешим *только* следующие модели для помощи в кодировании:
- **Grok Code Fast** - быстрая, экономически эффективная модель, идеальная для использования в качестве 'автодополнения на стероидах'
- **Claude Sonnet 4** - продвинутая модель, подходящая для сложного анализа кода и работы, но также более дорогая
- **Qwen Coder 3** - хорошо сбалансированная модель, обеспечивающая хорошую производительность для различных задач кодирования при сохранении хорошей точности и экономической эффективности

Все другие протестированные модели не смогли обеспечить удовлетворительные результаты в долгосрочной перспективе, часто производя неправильный или даже опасный код в неконтролируемых галлюцинациях.

### Руководящие принципы использования

1. **Дополнять, а не заменять**: ИИ-инструменты должны использоваться для помощи и улучшения человеческих усилий по кодированию, никогда для их полной замены.
2. **Обзор кода**: Весь код, сгенерированный ИИ в любом качестве, должен быть тщательно проверен и протестирован, чтобы убедиться, что он соответствует нашим высоким стандартам качества, безопасности и функциональности, как любой код.
3. **Осведомленность о безопасности**: Будьте бдительны в отношении потенциальных уязвимостей безопасности в коде, сгенерированном ИИ. ИИ может не всегда следовать лучшим практикам безопасности.

### Использование ИИ в переводах

Мы понимаем, что наличие LinuxToys на родных языках людей очень важно, поскольку это делает программное обеспечение более доступным, что является ключевым фактором нашего успеха. Однако это также очень трудоемкая задача, и гораздо более крупные проекты, чем наш, испытывают трудности с поиском добровольцев для помощи в этом, поэтому мы используем ИИ-инструменты для генерации переводов. О любых неточностях или ошибках в переводе следует сообщать на нашей [странице проблем GitHub](https://github.com/psygreg/linuxtoys/issues).

Модель, используемая в настоящее время для наших переводов, - **Claude Sonnet 4**, поскольку она показала лучшие результаты в наших тестах без отклонений от первоначального значения.
